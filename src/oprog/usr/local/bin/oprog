#!/bin/bash

SavePath="./savePath.bp"

# =============================
# –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å SavePath
# =============================
if [ -f "$SavePath" ] && [ -r "$SavePath" ]; then
    source "$SavePath"
    echo "Loaded system values from $SavePath"
else
    echo "SavePath not found or not readable. Using defaults."
fi

# =============================
#     –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
# =============================
[ -z "$ProProgDir" ] && ProProgDir="$HOME/OProg"
[ -z "$CONFIG_FILE" ] && CONFIG_FILE="$ProProgDir/OProgConfg.bp"

# =============================
# –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ SavePath, –µ—Å–ª–∏ –Ω–µ—Ç
# =============================
if [ ! -f "$SavePath" ]; then
    mkdir -p "$(dirname "$SavePath")"
    echo "ProProgDir=$ProProgDir" > "$SavePath"
    echo "CONFIG_FILE=$CONFIG_FILE" >> "$SavePath"
    echo "$SavePath was created with default system values."
fi

# =============================
#      –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
# =============================
if [ -z "$1" ]; then
    echo "Usage: $0 <program> or $0 help"
    exit 1
fi

# =============================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞
# =============================
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Config file $CONFIG_FILE not found!"
    read -p "Do you want to create it? (y/n) " a
    if [[ "$a" =~ ^[Yy]$ ]]; then
        mkdir -p "$ProProgDir"
        touch "$CONFIG_FILE"
        echo "$CONFIG_FILE was created. Please edit it to add programs."
        exit 0
    else
        echo "$CONFIG_FILE was not created, exiting."
        exit 1
    fi
fi

# =============================
#       –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞
# =============================
declare -A prog_paths
section=""
while IFS='=' read -r key value; do
    [[ -z "$key" || "$key" =~ ^# ]] && {
        [[ "$key" == "#systemValues" ]] && section="system"
        [[ "$key" == "#ProgramsPaths" ]] && section="programs"
        continue
    }

    case "$section" in
        system)
            eval "$key=$value"
            ;;
        programs)
            prog_paths["$key"]="$value"
            ;;
    esac
done < "$CONFIG_FILE"

param="$1"

# =============================
#         –ö–æ–º–∞–Ω–¥–∞ help
# =============================
if [[ "$param" == "help" ]]; then
    echo "Available programs and their paths/commands:"
    for prog in $(printf "%s\n" "${!prog_paths[@]}" | sort); do
        echo " - $prog => ${prog_paths[$prog]}"
    done
    exit 0
fi

if [[ "$1" == "add" ]]; then
    shift # —É–±–∏—Ä–∞–µ–º "add"
    if [ -z "$1" ]; then
        echo "Usage: $0 add <name=command/path [args]>"
        exit 1
    fi

    entry="$*"   # —Å–æ–±–∏—Ä–∞–µ–º –≤—Å—ë, —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å, –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É

    # –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –∫–æ–Ω—Ñ–∏–≥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if [ ! -f "$CONFIG_FILE" ]; then
        echo "Config file $CONFIG_FILE not found, creating..."
        mkdir -p "$(dirname "$CONFIG_FILE")"
        echo "#systemValues" > "$CONFIG_FILE"
        echo "#ProgramsPaths" >> "$CONFIG_FILE"
    fi

    # –î–æ–±–∞–≤–∏–º —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ —Å–µ–∫—Ü–∏–∏ #ProgramsPaths
    if grep -q "^#ProgramsPaths" "$CONFIG_FILE"; then
        sed -i "/^#ProgramsPaths/a $entry" "$CONFIG_FILE"
    else
        # –ï—Å–ª–∏ —Å–µ–∫—Ü–∏–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –µ—ë
        echo "#ProgramsPaths" >> "$CONFIG_FILE"
        echo "$entry" >> "$CONFIG_FILE"
    fi

    echo "Added program: $entry"
    exit 0
fi

# üü¢ –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
if [[ "$1" == "remove" ]]; then
    if [ -z "$2" ]; then
        echo "Usage: $0 remove <program>"
        exit 1
    fi

    prog_name="$2"

    if [ ! -f "$CONFIG_FILE" ]; then
        echo "Config file $CONFIG_FILE not found!"
        exit 1
    fi

    if grep -q "^$prog_name=" "$CONFIG_FILE"; then
        # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
        sed -i "/^$prog_name=/d" "$CONFIG_FILE"
        echo "Removed program: $prog_name"
    else
        echo "Program <$prog_name> not found in $CONFIG_FILE"
    fi

    exit 0
fi


# =============================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
# =============================
if [[ -n "${prog_paths[$param]}" ]]; then
    echo "Running <$param>..."
    eval "${prog_paths[$param]}"
    echo "Program <$param> has stopped"
    exit 0
else
    echo "Unknown program: <$param>"
    # –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π
    echo "Did you mean?"
    for prog in "${!prog_paths[@]}"; do
        if [[ "$prog" == $param* ]]; then
            echo " - $prog => ${prog_paths[$prog]}"
        fi
    done
    # –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫
    echo "Full list of available programs:"
    for prog in $(printf "%s\n" "${!prog_paths[@]}" | sort); do
        echo " - $prog => ${prog_paths[$prog]}"
    done
    exit 1
fi

